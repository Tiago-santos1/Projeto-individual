<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Dashboard do Quiz</title>
    <link rel="stylesheet" href="../css/dash.css">
</head>

<body onload="inicializarDashboard()">

    <div class="sidebar">
        <a href="/public/index.html"><img src="../assets/imgs/logo2.png" alt="Logo"></a>
        <p>Seja bem vindo ${nomeUsuario}</p>
        <div class="menu-item">Dashboard</div>

        <a href="..">
            <div class="menu-item">Sair</div>
        </a>


    </div>

    <div class="content">

        <div class="titulo">
            <h1>Você seria um bom aluno do Porto Seguro?</h1>
        </div>

        <div class="cards">
            <div class="card" id="kpi1">
                <h2>Sua Pontuação Final</h2>
                <div class="kpi-value" id="valor"></div>
                <p>Resultado da sua última tentativa.</p>
            </div>


            <div class="card" id="kpi3">
                <h2>Melhor Acerto Pessoal</h2>
                <div class="kpi-value">80%</div>
                <p>Seu recorde de pontuação.</p>
            </div>
        </div>

        <div class="linha">
            <div class="box" id="evolucao">
                <h2> Sua Evolução no Tempo</h2>
                <div style="height: 180px;">
                    <canvas id="graficoEvolucao"></canvas>
                </div>
            </div>

            <div class="box" id="erros">
                <h2> Meus Erros Comuns</h2>
                <ul class="ranking" style="list-style: none; padding-left: 0;">
                    <li class="erro-item" style="border-bottom: 1px solid #333; padding: 5px 0;">
                        **
                        <a href="#" class="erro-link" style="color: #00bfff; font-size: 0.8em;">
                        </a>
                    </li>
                    <li class="erro-item" style="border-bottom: 1px solid #333; padding: 5px 0;">
                        **
                        <a href="#" class="erro-link" style="color: #00bfff; font-size: 0.8em;">
                            Básica</a>
                    </li>
                    <li class="erro-item" style="padding: 5px 0;">
                        **
                        <a href="#" class="erro-link" style="color: #00bfff; font-size: 0.8em;"></a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="linha">
            <div class="box" id="topico">
                <h2> Desempenho por Tópico</h2>
                <div style="height: 180px; display: flex; align-items: center; justify-content: center;">
                    <canvas id="graficoTopico"></canvas>
                </div>
            </div>
        </div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <script>
        var idUsuario = sessionStorage.ID_USUARIO;

        fetch(`/quiz/listar/${idUsuario}`).then(function (res) {
            if (res.ok) {
                res.json().then(function (response) {
                    console.log(`Dados recebidos: ${JSON.stringify(response)}`);
                    montagrafico(response);
                });
            } else {
                console.log("Erro ao carregar gráfico.");
            }
        });

        function montagrafico(dadosDoGrafico) {
            const ctxEvolucao = document.getElementById('graficoEvolucao');

            new Chart(ctxEvolucao, {
                type: 'line',
                data: {
                    labels: ['Tentativa 1', 'Tentativa 2', 'Tentativa 3', 'Tentativa 4'],
                    datasets: [{
                        label: 'Nota do Usuário',
                        data: [dadosDoGrafico[0].errosPerguntas, dadosDoGrafico[0].acertos_perguntas],
                        borderWidth: 3,
                        borderColor: "#4cc9f0",
                        backgroundColor: "rgba(76, 201, 240, 0.25)",
                        tension: 0.35,
                        pointRadius: 5,
                        pointBorderWidth: 2,
                        pointBackgroundColor: "#4cc9f0",
                        pointBorderColor: "#ffffff"
                    }, {
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,

                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff',
                                font: { size: 14 }
                            }
                        }
                    },

                    scales: {
                        x: {
                            ticks: {
                                color: "#ffffff",
                                font: { size: 14 }
                            },
                            grid: {
                                color: "rgba(255,255,255,0.05)"
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: "#ffffff",
                                font: { size: 14 }
                            },
                            grid: {
                                color: "rgba(255,255,255,0.05)"
                            }
                        }
                    }
                }
            });
        }

        const ctxTopico = document.getElementById('graficoTopico');

        new Chart(ctxTopico, {
            type: 'doughnut',
            data: {
                labels: ['Acertos (10%)', 'Erros (90%)'],
                datasets: [{
                    label: 'Acertos %',
                    data: [10, 90],
                    backgroundColor: [
                        '#4895ef',
                        '#f72585'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#ffffff',
                            font: { size: 14 }
                        }
                    }
                }
            }
        });

        function kpiPercentual() {
            var id = sessionStorage.ID_USUARIO;

            fetch(`/quiz/listar/${id}`)
                .then(function (response) {
                    if (response.ok) {
                        response.json().then(function (respostas) {
                            var resposta = respostas[respostas.length - 1]
                            valor.innerHTML = `${(resposta.percentual)}%`;
                        })
                    }
                })
        }

        function inicializarDashboard() {
            kpiPercentual();
        }


    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</body>

</html>